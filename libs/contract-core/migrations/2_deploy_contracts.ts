import path from 'path';
import { existsSync, mkdirSync, writeFileSync } from 'fs';
import { MigrationStep } from './step';
import { getSigner } from '@thecointech/signers';

// It seems the types for deployProxy don't match the types
// generated by typechain.  We use require to strip the
// typing from OZ, as the function seems to work fine anyway
const { deployProxy } = require('@openzeppelin/truffle-upgrades');

const step: MigrationStep = (artifacts) =>
  async (deployer, network, _accounts) => {

    const contract = artifacts.require("TheCoin");

    const tcSigner = await getSigner('TheCoin');
    const tcAddr = await tcSigner.getAddress();
    const proxy = await deployProxy(contract, [tcAddr], { deployer });

    // Serialize our contract addresses
    const outdir = path.join(__dirname, '..', 'src', 'deployed');
    if (!existsSync(outdir))
      mkdirSync(outdir);

    // Our contract-specific data (eg impl address, ProxyAdmin address etc) is in ../.openzeppelin/{network}.json
    const jsonFile = path.join(outdir, `${network}.json`);
    writeFileSync(jsonFile, JSON.stringify({
      proxy: proxy.address,
    }))
  }

module.exports = step
