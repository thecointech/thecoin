# A token may be presented to a broker
# as proof of funds.  If signed by the
# broker, it indicates the client is trusted
# and sufficient balance to cover the
# available balance listed here.
TapCapToken:
  required:
    - clientAccount
    - availableBalance
    - transactionId
    - timestamp
  properties:
    clientAccount:
      type: string
    availableBalance:
      type: number
      format: int64    
    transactionId:
      type: number
    # The timestamp of issue.  A broker
    # may ignore a token if the timestamp is too old
    timestamp:
      type: number
      format: int64

# A token signed by the TapCapManager
TapCapTokenSigned:
  required:
    - token
    - signature
  properties:
    token:
      type: string
    signature:
      type: string

# A purchase request is sent to a broker.  If
# the broker satisfies the request, the signed
# purchase structure may be forwarded to the
# manager for settlement
TapCapPurchase:
  required:
    - fiat
    - currencyCode
    - timestamp
    - token # Every successful transaction ibcrements this number
  properties:
    fiat:
      type: number
    currencyCode:
      type: number
    timestamp:  # Only requests in the past X seconds will be acccepted?  Security risk here?
      type: number
      format: int64
    token:
      $ref: "#/TapCapTokenSigned"

# A client signs the initial purchase request
# and sends this request to the Broker
TapCapPurchaseSigned:
  required:
    - request
    - signature
  properties:
    request:
      type: string
    signature:
      type: string

# If the broker accepts the request, they generate
# this response structure, fill out the fields and
# return to the client.
TapCapPurchaseBroker:
  required:
    - clientRequest
    - coin
    - cert
  properties:
    # The ClientRequest is a JSON string of TapCapPurchaseSigned
    clientRequest:
      type: string
    coin:  # The amount of coin being charged for this transaction
      type: number
      format: int64
    cert:
      type: string

# The broker signs the return structure to 
# guarantee the purchase will be successful
TapCapPurchaseBrokerSigned:
  required:
    - purchaseRequest
    - signature
  properties:
    purchaseRequest:
      # A purchase request is a JSON String of TapCapPurchaseBroker
      type: string
    signature:
      type: string

# The client finally signs the result, and submits
# to the central bank to confirm all has gone to plan
TapCapPurchaseFinalSigned:
  required:
    - brokerSigned
    - signature
  properties:
    brokerSigned:
      # A purchase request is a JSON String of TapCapPurchaseBrokerSigned
      type: string
    signature:
      type: string

# ---------------------------------------------------------------- #

# Query the Manager for a clients TapCap balance  
TapCapQueryRequest:
  required:
  - timestamp
  - random
  properties:
    timestamp:  # Only requests in the past  seconds will be acccepted?  Security risk here?
      type: number
      format: int64
    random:     # Randomly generated by client.  Only used to validate the signature
      type: string

# Signed request ensures it could only have come
# from the client
TapCapQueryRequestSigned:
  required:
    - request
    - signature
  properties:
    request:
      $ref: "#/TapCapQueryRequest"
    signature:
      type: string

# basic stats 
TapCapQueryResponse:
  required:
  - balance
  - weeklyTopup
  - token
  properties:
    balance:
      type: number
      format: int64
    weeklyTopup:
      type: number
      format: int64
    token: 
      $ref: "#/TapCapTokenSigned"

TapCapHistoryRequest:
  required:
  - fromTimestamp
  - untilTimestamp
  - msgTimestamp 
  properties:
    fromTimestamp:
      type: number
      format: int64
    untilTimestamp:
      type: number
      format: int64
    # Only requests from the preceding 5 seconds will be fullfilled.
    # This prevents someone copying/cloning a message and using repeating it later.
    msgTimestamp:
      type: number
      format: int64

TapCapHistoryRequestSigned:
  required:
    - request
    - signature
  properties:
    request:
      $ref: "#/TapCapHistoryRequest"
    signature:
      type: string
      
TapCapTransaction:
  required:
    - timestamp
    - fiatAmount
    - coinAmount
    - coinBalance
    - merchantId
  properties:
    timestamp:
      type: number
      format: int64
    fiatAmount:
      type: number
      format: double
    coinAmount:
      type: number
      format: int64
    merchantId:
      type: string

TapCapHistoryResponse:
  required:
    - history
  properties:
    history:
      type: array
      items:
        $ref: "#/TapCapTransaction"

TapCapHistoryResponseSigned:
  required:
    - response
    - signature
  properties:
    response:
      $ref: "#/TapCapHistoryResponse"
    signature:
      type: string          
