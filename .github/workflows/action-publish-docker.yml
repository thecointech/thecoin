name: Build and Push Docker Images

on:
  workflow_call:
    inputs:
      COMMIT_SHA:
        required: true
        type: string
        description: 'Commit SHA to build from'
      CONFIG_NAME:
        required: true
        type: string
        description: 'Environment to deploy to (prodtest, prodbeta, prod)'
      IS_PROMOTION:
        required: false
        type: boolean
        default: false
        description: 'If true, retag existing test image instead of rebuilding'

env:
  REGISTRY: ghcr.io
  TX_PROCESSOR_IMAGE: ${{ github.repository }}/tx-processor
  VQA_SERVICE_IMAGE: ${{ github.repository }}/vqa-service

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write
    environment: ${{ inputs.CONFIG_NAME }}

    steps:

      - uses: actions/checkout@v4
        if: inputs.IS_PROMOTION == false
        with:
          ref: ${{ inputs.COMMIT_SHA }}

      - run: corepack enable
        if: inputs.IS_PROMOTION == false

      - name: Use Node.js
        if: inputs.IS_PROMOTION == false
        uses: actions/setup-node@v4
        with:
          node-version: '22.19'

      - name: Download build artifacts
        if: inputs.IS_PROMOTION == false
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: Set up Docker Buildx
        if: inputs.IS_PROMOTION == false
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for tx-processor
        id: meta-tx
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.TX_PROCESSOR_IMAGE }}
          flavor: |
            latest=false
          tags: |
            type=raw,value=${{ inputs.CONFIG_NAME }}-latest
            type=raw,value=${{ inputs.CONFIG_NAME }}-${{ inputs.COMMIT_SHA }}
            type=sha,format=long

      # For promotions, retag existing prodtest image
      - name: Promote tx-processor image (retag)
        if: inputs.IS_PROMOTION == true
        run: |
          echo "Promoting prodtest image to ${{ inputs.CONFIG_NAME }}"

          # Pull the prodtest image
          SOURCE_TAG="prodtest-${{ inputs.COMMIT_SHA }}"
          docker pull ${{ env.REGISTRY }}/${{ env.TX_PROCESSOR_IMAGE }}:${SOURCE_TAG}

          # Retag for new environment
          docker tag \
            ${{ env.REGISTRY }}/${{ env.TX_PROCESSOR_IMAGE }}:${SOURCE_TAG} \
            ${{ env.REGISTRY }}/${{ env.TX_PROCESSOR_IMAGE }}:${{ inputs.CONFIG_NAME }}-latest

          docker tag \
            ${{ env.REGISTRY }}/${{ env.TX_PROCESSOR_IMAGE }}:${SOURCE_TAG} \
            ${{ env.REGISTRY }}/${{ env.TX_PROCESSOR_IMAGE }}:${{ inputs.CONFIG_NAME }}-${{ inputs.COMMIT_SHA }}

          # Push new tags
          docker push ${{ env.REGISTRY }}/${{ env.TX_PROCESSOR_IMAGE }}:${{ inputs.CONFIG_NAME }}-latest
          docker push ${{ env.REGISTRY }}/${{ env.TX_PROCESSOR_IMAGE }}:${{ inputs.CONFIG_NAME }}-${{ inputs.COMMIT_SHA }}

          echo "âœ… Image promoted successfully"

      # - name: Extract metadata for VQA Service
      #   id: meta-vqa
      #   uses: docker/metadata-action@v5
      #   with:
      #     images: ${{ env.REGISTRY }}/${{ env.VQA_SERVICE_IMAGE }}
      #     tags: |
      #       type=ref,event=branch
      #       type=sha,format=long

      - name: Prep tx-processor
        if: inputs.IS_PROMOTION == false
        run: node --experimental-strip-types ./docker/prep-docker.ts
        working-directory: ./apps/tx-processor
        env:
          GH_PACKAGES_READ: ${{ secrets.GH_PACKAGES_READ }}
          CONFIG_NAME: ${{ inputs.CONFIG_NAME }}

      - name: Build and push tx-processor
        if: inputs.IS_PROMOTION == false
        uses: docker/build-push-action@v5
        with:
          context: ./apps/tx-processor
          file: ./apps/tx-processor/docker/Dockerfile
          push: true
          platforms: linux/amd64
          tags: ${{ steps.meta-tx.outputs.tags }}
          labels: ${{ steps.meta-tx.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # TODO: vqa-service is only run locally for now
      # - name: Prep vqa-service
      #   run: node --experimental-strip-types ./tools/build-docker.ts
      #   working-directory: ./apps/vqa-service
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #     VqaSslCertPublic: ${{ secrets.VqaSslCertPublic }}
      #     VqaSslCertPrivate: ${{ secrets.VqaSslCertPrivate }}
      #     VqaApiKey: ${{ secrets.VqaApiKey }}

      # - name: Build and push vqa-service
      #   uses: docker/build-push-action@v5
      #   with:
      #     context: ./apps/vqa-service
      #     file: ./apps/vqa-service/Dockerfile
      #     push: true
      #     tags: ${{ steps.meta-vqa.outputs.tags }}
      #     labels: ${{ steps.meta-vqa.outputs.labels }}
      #     cache-from: type=gha,scope=vqa-service
      #     cache-to: type=gha,mode=max,scope=vqa-service
