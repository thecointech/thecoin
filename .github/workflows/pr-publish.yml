name: Publish Everything Base

on:
  workflow_call:
    inputs:
      CONFIG_NAME:
        required: true
        type: string
        description: 'configName to deploy to (prodtest, prodbeta, prod)'

# Cancel any in-progress job or run
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate-configName:
    runs-on: ubuntu-latest
    environment: ${{ inputs.CONFIG_NAME }}
    steps:
      - name: Validate configName
        run: |
          if [ "${{ inputs.CONFIG_NAME }}" != "prodtest" ] && [ "${{ inputs.CONFIG_NAME }}" != "prodbeta" ] && [ "${{ inputs.CONFIG_NAME }}" != "prod" ]; then
            echo "::error::Unknown configName: ${{ inputs.CONFIG_NAME }}"
            exit 1
          fi

  build:
    needs: validate-configName
    uses: ./.github/workflows/action-build.yml

  publish-packages:
    permissions:
      contents: write  # For git operations and version bumps
      packages: write  # For package publishing
    needs: build
    uses: ./.github/workflows/action-publish-packages.yml
    with:
      CONFIG_NAME: ${{ inputs.CONFIG_NAME }}

  publish-docker:
    needs: publish-packages
    uses: ./.github/workflows/action-publish-docker.yml
    secrets: inherit
    with:
      CONFIG_NAME: ${{ inputs.CONFIG_NAME }}
      COMMIT_SHA: ${{ needs.publish-packages.outputs.latest_sha }}

  publish-services:
    needs: publish-packages
    secrets: inherit
    uses: ./.github/workflows/action-publish-services.yml
    with:
      CONFIG_NAME: ${{ inputs.CONFIG_NAME }}
      COMMIT_SHA: ${{ needs.publish-packages.outputs.latest_sha }}

  publish-sites:
    needs: publish-packages
    secrets: inherit
    uses: ./.github/workflows/action-publish-sites.yml
    with:
      CONFIG_NAME: ${{ inputs.CONFIG_NAME }}
      COMMIT_SHA: ${{ needs.publish-packages.outputs.latest_sha }}

  merge-to-dev:
    name: Create Merge-Back Pull Request
    runs-on: ubuntu-latest
    needs: [publish-services, publish-sites, publish-docker]
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Create Pull Request to merge back to dev
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --base dev \
            --head ${{ github.base_ref }} \
            --title "chore: Merge ${{ github.base_ref }} to dev" \
            --body "Automated PR to merge release branch back to dev. This contains version bumps and any hotfixes applied during the release process."

  cleanup:
    needs: [publish-services, publish-sites, publish-docker]
    uses: ./.github/workflows/action-cleanup-old-packages.yml
    secrets: inherit
